<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>USB HID Connection Example</title>
    <style>
        [v-cloak] {
            visibility: hidden;
        }

        pre, code {
            font-family: Consolas, serif;
        }

        #app {
            display: flex;
            flex-direction: column;
            align-content: center;
            flex-wrap: wrap;
        }

        .container {
            display: flex;
            flex-direction: column;
            align-content: flex-start;
            flex-wrap: wrap;
            max-width: 1000px;
        }
        .logo {
            object-fit: contain;
            margin: 0 auto;
        }
    </style>
</head>
<body>
<div id="app" v-cloak>
    <div class="container">
        <img src="../static/logo.png" alt="Logo" class="logo"/>
        <h1>USB HID Connection Example (JavaScript)</h1>
        <p>GitHub: <a href="https://github.com/wingflexsim/DevDocument">https://github.com/wingflexsim/DevDocument</a>
        </p>
        <p>Official Website: <a href="https://wingflexsim.com/">https://wingflexsim.com/</a></p>
        <p>We recommend reading the HTML source code of this example page to understand the code implementation details.</p>
        <div>
            <h2>0. Check if your browser supports USB HID functionality: {{ isSupportUSBHID ? "Supported" : "Not Supported" }}</h2>
            <p>(If it shows not supported, please use modern browsers like Chrome, Edge, etc.)</p>
            <p>Example code:</p>
            <pre>
        if(navigator.hid !== undefined){
            // Condition is true if supported
            isSupportUSBHID.value = true;
        }
        </pre>
        </div>
        <div>
            <h2>1. Select Device</h2>
            Please select a device that starts with WINGFLEX. Make sure to close the WINGFLEX Bridge software before connecting to avoid conflicts.
            <p>(Due to browser security restrictions, the device selection dialog can only be triggered by user action, such as clicking a button.)</p>
            <input type="button" value="Click to Select Device" @click="selectDevice"/>
            <p>
                Currently selected device: {{
                    currentDevice ? `${currentDevice.productName}(VID: ${currentDevice.vendorId}, PID: ${currentDevice.productId})` : "Not Selected"
                }}</p>
            <p>Example code:</p>
            <pre>
        function selectDevice() {
            navigator.hid.requestDevice({filters: []})
                .then(async (selectedDevices) => {
                    // Handle user cancellation of device selection
                    if (selectedDevices[0] === undefined) {
                        alert("User cancelled selection")
                        return;
                    }

                    // Handle when user selects a device, check console for object details
                    let device = selectedDevices[0];
                    console.log("Selected device:")
                    console.log(device)

                    // Pass the device object to Vue reactive object for displaying device info in HTML
                    currentDevice.value = device
                });
        }
        </pre>
        </div>
        <div>
            <h2>2. Register Input Report Event</h2>
            <p>In Web USB HID development, you can register the <code>oninputreport</code> event of <code>HidDevice</code> to receive data sent from the device to the computer.
            </p>
            <p>After connecting the device, you can press the AP1 and AP2 buttons for testing.</p>
            <p>AP1 Button: {{AP1Switch?"Pressed":"Not Pressed"}} | AP2 Button: {{ AP2Switch ? "Pressed" : "Not Pressed"}} </p>
            <p>Timestamp: <code>{{ uplinkTimestamp }} ms</code></p>
            <p>Device uplink real-time data: <code>{{ currentUplinkStr }}</code></p>
            <p>Example code:</p>
            <pre>
        // Register input report event
        device.oninputreport = (event) => {
            // Record timestamp
            uplinkTimestamp.value = new Date().getTime();
            // Read 64 bytes of uint8 type data
            let data = [];
            for (let i = 0; i < 64; i++) {
                data[i] = event.data.getUint8(i);
            }
            AP1Switch.value = !!(data[7] & 0x20);
            AP2Switch.value = !!(data[7] & 0x40);

            // Keep a copy of the data for subsequent parsing and processing
            uplinkMsgArr.value = data;
            // Format output to the page
            currentUplinkStr.value = data.map(item => {
                return item.toString(16);
            }).join(" ");
        };
        </pre>
        </div>
        <div>
            <h2>3. Send Data to Device</h2>
            <p>Taking the A320 FCU CUBE device as an example, you can click the button below to send sample data and observe the device changes.</p>
            <p>This will send 64 bytes per frame of report 0 data to the device. Due to the data disconnection detection, the device will turn off the lights within 1-3 seconds.</p>
            <div>
                <input type="button" value="Turn On Lights" @click="openFcuLight">
            </div>
            <p>Example code</p>
            <pre>
        // Turn on FCU CUBE lights
        function openFcuLight() {
            if (currentDevice.value && currentDevice.value.opened) {
                console.log(currentDevice.value);
                // 64 Bytes Uint8 array
                const msgArray = new Uint8Array(64);
                msgArray[0] = 0xF2;
                msgArray[1] = 0xE1;
                msgArray[2] = 0x03;

                msgArray[3] = 0x02;
                msgArray[4] = 0x01;
                msgArray[5] = 0x02;

                msgArray[6] = 0x01;
                msgArray[7] = 0x00;
                msgArray[8] = 0x01;

                msgArray[9] = 0x02;
                msgArray[10] = 0x02;
                msgArray[11] = 0xff;
                msgArray[12] = 0xff;

                msgArray[13] = 0x03;
                msgArray[14] = 0x08;
                msgArray[15] = 0x00;
                msgArray[16] = 0x7B;
                msgArray[17] = 0x01;
                msgArray[18] = 0xC8;
                msgArray[19] = 0x03;
                msgArray[20] = 0x15;
                msgArray[21] = 0x00;
                msgArray[22] = 0x00;
                console.log(msgArray);

                // Send data to the device with report 0
                currentDevice.value.sendFeatureReport(0, msgArray);
            }
        }
            </pre>
        </div>
        <div>
            <h2>4. Further Understanding of Protocol Details</h2>
            <p>You can continue to access the A320 FCU CUBE documentation for detailed protocol explanations.</p>
            <p>You can also check the source code of this HTML page to understand the complete communication process.</p>
        </div>
        <div>
            &copy;WINGFLEX 2025
        </div>
        <div style="height: 250px"></div>
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.5.18/vue.global.prod.min.js"
        integrity="sha512-UyWj9VA5pQrLGoqDUNeT9ciMYGkWexsNHnMQksL9eeiRQyHzD9nIHAj9JzUrbaJ8XRukAkZkQS9EKCnx/Dc8Lw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    // Create Vue application using Vue3 Composition API
    const {createApp, ref} = Vue;

    const app = createApp({
        setup() {
            const message = ref("Hello, Vue3!");
            const isSupportUSBHID = ref(false); // Flag indicating whether USB HID is supported
            const currentDevice = ref(null); // Current connected device object
            const uplinkTimestamp = ref(0); // Uplink data timestamp
            const uplinkMsgArr = ref(null); // Uplink data array
            const currentUplinkStr = ref(""); // Uplink data string
            const AP1Switch = ref(false); // AP1 button state
            const AP2Switch = ref(false); // AP2 button state

            // Check if your browser supports USB HID functionality
            if (navigator.hid !== undefined) {
                isSupportUSBHID.value = true;
            }

            // Browser popup to select USB HID device
            function selectDevice() {
                navigator.hid.requestDevice({
                    filters: [
                        {
                            // FCU CUBE
                            vendorId: 0xA316,
                            productId: 0xC787,
                        }
                    ]
                })
                    .then(async (selectedDevices) => {
                        // Handle user cancellation of device selection
                        if (selectedDevices[0] === undefined) {
                            alert("User cancelled selection");
                            return;
                        }

                        // Handle when user selects a device, check console for object details
                        let device = selectedDevices[0];
                        console.log("Selected device:");
                        console.log(device);

                        // Register input report event
                        device.oninputreport = (event) => {
                            // Record timestamp
                            uplinkTimestamp.value = new Date().getTime();
                            // Read 64 bytes of uint8 type data
                            let data = [];
                            for (let i = 0; i < 64; i++) {
                                data[i] = event.data.getUint8(i);
                            }
                            AP1Switch.value = !!(data[7] & 0x20);
                            AP2Switch.value = !!(data[7] & 0x40);

                            // Keep a copy of the data for subsequent parsing and processing
                            uplinkMsgArr.value = data;
                            // Format output to the page
                            currentUplinkStr.value = data.map(item => {
                                return item.toString(16);
                            }).join(" ");
                        };

                        // Pass the device object to Vue reactive object for displaying device info in HTML
                        currentDevice.value = device;
                        // Open the device
                        await device.open();
                    });
            }

            // Turn on FCU CUBE lights
            function openFcuLight() {
                if (currentDevice.value && currentDevice.value.opened) {
                    console.log(currentDevice.value);
                    // 64 Bytes Uint8 array
                    const msgArray = new Uint8Array(64);
                    msgArray[0] = 0xF2;
                    msgArray[1] = 0xE1;
                    msgArray[2] = 0x03;

                    msgArray[3] = 0x02;
                    msgArray[4] = 0x01;
                    msgArray[5] = 0x02;

                    msgArray[6] = 0x01;
                    msgArray[7] = 0x00;
                    msgArray[8] = 0x01;

                    msgArray[9] = 0x02;
                    msgArray[10] = 0x02;
                    msgArray[11] = 0xff;
                    msgArray[12] = 0xff;

                    msgArray[13] = 0x03;
                    msgArray[14] = 0x08;
                    msgArray[15] = 0x00;
                    msgArray[16] = 0x7B;
                    msgArray[17] = 0x01;
                    msgArray[18] = 0xC8;
                    msgArray[19] = 0x03;
                    msgArray[20] = 0x15;
                    msgArray[21] = 0x00;
                    msgArray[22] = 0x00;
                    console.log(msgArray);

                    // Send data to the device with report 0
                    currentDevice.value.sendFeatureReport(0, msgArray);
                }
            }

            return {
                message,
                isSupportUSBHID,
                currentDevice,
                currentUplinkStr,
                uplinkTimestamp,
                AP1Switch,
                AP2Switch,
                selectDevice,
                openFcuLight,
            };
        }
    });

    // Mount Vue application to element in HTML
    app.mount("#app");
</script>
</body>
</html>